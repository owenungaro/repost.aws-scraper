{
  "body": "I have an S3 bucked with access limited only from my external server by ip address:\n{\n    \"Version\": \"2012-10-17\",\n    \"Id\": \"BackupPolicy01\",\n    \"Statement\": [\n        {\n            \"Sid\": \"BackupPolicy01\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"AWS\": \"arn:aws:iam::83743546469343:user/user-backup\"\n            },\n            \"Action\": \"s3:*\",\n            \"Resource\": [\n                \"arn:aws:s3:::my-backup/*\",\n                \"arn:aws:s3:::my-backup\"\n            ],\n            \"Condition\": {\n                \"IpAddress\": {\n                    \"aws:SourceIp\": \"123.87.210.171/32\"\n                }\n            }\n        }\n    ]\n}\nNow I'm trying to add a Backup Plan using the default role, but it fails due to missing permissions.\nI tried to search how to give access to defaul backup rules but I didn't find it.\n\nTo allow AWS Backup to work with your S3 bucket while maintaining your strict access controls, you need to modify your bucket policy to include an exception for the AWS Backup service role. Here's how to do it:\nFirst, identify the Role ID of the AWS Backup service role you're using. You can find this using the AWS CLI command:\naws iam get-role --role-name AWSBackupDefaultServiceRole\nLook for the \"RoleId\" value in the response (it will look something like \"AROASAMPLESAMPLESAMPL\").\nModify your bucket policy to include an exception for the AWS Backup role while maintaining your IP restriction:\n{\n    \"Version\": \"2012-10-17\",\n    \"Id\": \"BackupPolicy01\",\n    \"Statement\": [\n        {\n            \"Sid\": \"BackupPolicy01\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"AWS\": \"arn:aws:iam::837409669343:user/user-backup\"\n            },\n            \"Action\": \"s3:*\",\n            \"Resource\": [\n                \"arn:aws:s3:::my-backup/*\",\n                \"arn:aws:s3:::my-backup\"\n            ],\n            \"Condition\": {\n                \"IpAddress\": {\n                    \"aws:SourceIp\": \"123.87.210.171/32\"\n                }\n            }\n        },\n        {\n            \"Sid\": \"AllowAWSBackupService\",\n            \"Effect\": \"Allow\",\n            \"Principal\": {\n                \"Service\": \"backup.amazonaws.com\"\n            },\n            \"Action\": \"s3:*\",\n            \"Resource\": [\n                \"arn:aws:s3:::my-backup/*\",\n                \"arn:aws:s3:::my-backup\"\n            ],\n            \"Condition\": {\n                \"StringLike\": {\n                    \"aws:userid\": \"BACKUP_ROLE_ID:*\"\n                }\n            }\n        }\n    ]\n}\nReplace \"BACKUP_ROLE_ID\" with the actual Role ID you found in step 1.\nMake sure your AWS Backup role has the necessary permissions by attaching these managed policies:\nAWSBackupServiceRolePolicyForS3Backup\nAWSBackupServiceRolePolicyForS3Restore\nThis approach allows you to maintain your strict IP-based access control while creating an exception specifically for the AWS Backup service to perform backup operations on your S3 bucket.\nSources\nPerform AWS Backup on S3 with access restricted to VPC | AWS re:Post\nAmazon S3 backups - AWS Backup\n\nHello.\nThe bucket policy you shared only has the Allow statement set, so I think you will be able to perform backups if the IAM policy for S3 access is set in the IAM role for AWS Backup.\nPlease make sure that you have set \"AWSBackupServiceRolePolicyForS3Backup\" and \"AWSBackupServiceRolePolicyForS3Restore\" to the AWS Backup IAM role as described in the following document.\nhttps://docs.aws.amazon.com/aws-backup/latest/devguide/s3-backups.html#s3-backup-prerequisites"
}