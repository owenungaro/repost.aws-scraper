{
  "body": "I created below life cycle policy for ECR\nBut all images other than latest 20 get expired.\nI want to keep latest 20 and the images within 6 month.\nto be clear - there can be more images than 20 if they ar within last six month\n{\n  \"rules\": [\n    {\n      \"rulePriority\": 1,\n      \"description\": \"Latest\",\n      \"selection\": {\n        \"tagStatus\": \"tagged\",\n        \"tagPrefixList\": [\n          \"latest\"\n        ],\n        \"countType\": \"sinceImagePushed\",\n        \"countUnit\": \"days\",\n        \"countNumber\": 9999\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    },\n    {\n      \"rulePriority\": 2,\n      \"description\": \"Keep 20 most recent images\",\n      \"selection\": {\n        \"tagStatus\": \"tagged\",\n        \"tagPatternList\": [\n          \"*\"\n        ],\n        \"countType\": \"imageCountMoreThan\",\n        \"countNumber\": 20\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    },\n    {\n      \"rulePriority\": 3,\n      \"description\": \"Expire all images older than 180 days\",\n      \"selection\": {\n        \"tagStatus\": \"any\",\n        \"countType\": \"sinceImagePushed\",\n        \"countUnit\": \"days\",\n        \"countNumber\": 1800\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    }\n  ]\n}```\n\nYou're right to be concerned about the second condition potentially expiring all images after 50. To create an ECR lifecycle policy that meets your requirements, you'll need to carefully structure your rules. Here's how you can approach this:\nTo retain the latest image:\nCreate a rule with the highest priority that keeps the image tagged as \"latest\".\nTo keep the newest 50 images:\nAdd a rule that retains the 50 most recent images, regardless of their tags.\nTo keep images within the last 6 months:\nInclude a rule that keeps images pushed within the last 180 days.\nHere's a suggested structure for your lifecycle policy:\n{\n\"rules\"\n:\n[\n{\n\"rulePriority\"\n:\n1\n,\n\"description\"\n:\n\"Keep image with 'latest' tag\"\n,\n\"selection\"\n:\n{\n\"tagStatus\"\n:\n\"tagged\"\n,\n\"tagPrefixList\"\n:\n[\n\"latest\"\n]\n,\n\"countType\"\n:\n\"imageCountMoreThan\"\n,\n\"countNumber\"\n:\n1\n}\n,\n\"action\"\n:\n{\n\"type\"\n:\n\"expire\"\n}\n}\n,\n{\n\"rulePriority\"\n:\n2\n,\n\"description\"\n:\n\"Keep newest 50 images\"\n,\n\"selection\"\n:\n{\n\"tagStatus\"\n:\n\"any\"\n,\n\"countType\"\n:\n\"imageCountMoreThan\"\n,\n\"countNumber\"\n:\n50\n}\n,\n\"action\"\n:\n{\n\"type\"\n:\n\"expire\"\n}\n}\n,\n{\n\"rulePriority\"\n:\n3\n,\n\"description\"\n:\n\"Keep images from last 6 months\"\n,\n\"selection\"\n:\n{\n\"tagStatus\"\n:\n\"any\"\n,\n\"countType\"\n:\n\"sinceImagePushed\"\n,\n\"countUnit\"\n:\n\"days\"\n,\n\"countNumber\"\n:\n180\n}\n,\n\"action\"\n:\n{\n\"type\"\n:\n\"expire\"\n}\n}\n]\n}\nThis policy will work as follows:\nThe first rule ensures that the image tagged \"latest\" is always kept.\nThe second rule keeps the 50 most recent images, preventing them from being expired by the third rule.\nThe third rule keeps all images pushed within the last 180 days (approximately 6 months).\nRemember that in ECR lifecycle policies, rules are evaluated in order of priority (lower numbers are higher priority). An image that matches a higher priority rule cannot be expired by a lower priority rule. This way, your policy will retain the latest image, the newest 50 images, and all images from the last 6 months, whichever is greater.\nAlways use the lifecycle policy preview feature before applying the policy to ensure it behaves as expected with your specific set of images.\nSources\nAutomate the cleanup of images by using lifecycle policies in Amazon ECR - Amazon ECR\nIn ECR I created a lifecycle policy to keep images for 10 years but it deleted them instead | AWS re:Post\nExamples of lifecycle policies in Amazon ECR - Amazon ECR\n\nSo on this case according to second rule after 50 images they will be deleted right"
}