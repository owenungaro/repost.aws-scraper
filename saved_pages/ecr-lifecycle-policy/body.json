{
  "body": "I created below life cycle policy for ECR\nBut all images other than latest 20 get expired.\nI want to keep latest 20 and the images within 6 month.\nto be clear - there can be more images than 20 if they ar within last six month\n{\n  \"rules\": [\n    {\n      \"rulePriority\": 1,\n      \"description\": \"Latest\",\n      \"selection\": {\n        \"tagStatus\": \"tagged\",\n        \"tagPrefixList\": [\n          \"latest\"\n        ],\n        \"countType\": \"sinceImagePushed\",\n        \"countUnit\": \"days\",\n        \"countNumber\": 9999\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    },\n    {\n      \"rulePriority\": 2,\n      \"description\": \"Keep 20 most recent images\",\n      \"selection\": {\n        \"tagStatus\": \"tagged\",\n        \"tagPatternList\": [\n          \"*\"\n        ],\n        \"countType\": \"imageCountMoreThan\",\n        \"countNumber\": 20\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    },\n    {\n      \"rulePriority\": 3,\n      \"description\": \"Expire all images older than 180 days\",\n      \"selection\": {\n        \"tagStatus\": \"any\",\n        \"countType\": \"sinceImagePushed\",\n        \"countUnit\": \"days\",\n        \"countNumber\": 1800\n      },\n      \"action\": {\n        \"type\": \"expire\"\n      }\n    }\n  ]\n}```\n\n\nand also we cant have two rules with tagStatus with any\n\nYes, you're right \u2014 in your current setup, if\nall 20 latest tagged images are older than 180 days\n, they\nwill still be expired\ndue to the\nsinceImagePushed > 180 days\nrule.\nThis happens because\nAmazon ECR lifecycle rules are evaluated in order of priority\n, and\nonce a rule matches, it's applied immediately\n\u2014 even if a later rule would have preserved the image.\n\nHello,\n\u26a0 Issues in Your Current Policy:\nContradictory rules:\nrulePriority: 2 expires images if count > 20 \u2014 this is causing deletion of images even if they\u2019re within 180 days.\nrulePriority: 3 tries to expire images older than 1800 days \u2014 seems like a typo (should be 180 days).\ntagStatus: any used in multiple rules \u2013 AWS only allows one rule with tagStatus: any in a lifecycle policy.\nTo retain the\nlatest 20 images\nand\nall images pushed within the last 180 days\nin Amazon ECR, structure your lifecycle policy using the following rules:\n{\n\"rules\"\n:\n[\n{\n\"rulePriority\"\n:\n1\n,\n\"description\"\n:\n\"Expire untagged images older than 180 days\"\n,\n\"selection\"\n:\n{\n\"tagStatus\"\n:\n\"untagged\"\n,\n\"countType\"\n:\n\"sinceImagePushed\"\n,\n\"countUnit\"\n:\n\"days\"\n,\n\"countNumber\"\n:\n180\n}\n,\n\"action\"\n:\n{\n\"type\"\n:\n\"expire\"\n}\n}\n,\n{\n\"rulePriority\"\n:\n2\n,\n\"description\"\n:\n\"Expire tagged images older than 180 days\"\n,\n\"selection\"\n:\n{\n\"tagStatus\"\n:\n\"tagged\"\n,\n\"countType\"\n:\n\"sinceImagePushed\"\n,\n\"countUnit\"\n:\n\"days\"\n,\n\"countNumber\"\n:\n180\n}\n,\n\"action\"\n:\n{\n\"type\"\n:\n\"expire\"\n}\n}\n,\n{\n\"rulePriority\"\n:\n3\n,\n\"description\"\n:\n\"Retain the 20 most recent tagged images\"\n,\n\"selection\"\n:\n{\n\"tagStatus\"\n:\n\"tagged\"\n,\n\"countType\"\n:\n\"imageCountMoreThan\"\n,\n\"countNumber\"\n:\n20\n}\n,\n\"action\"\n:\n{\n\"type\"\n:\n\"expire\"\n}\n}\n]\n}\nThis setup ensures:\nImages pushed in the last 180 days are preserved.\nAt least 20 recent tagged images are kept, even if older than 180 days.\nUntagged images older than 180 days are expired.\nNote: Amazon ECR allows only one rule with\ntagStatus: any\n, so separate rules for\ntagged\nand\nuntagged\nare necessary.\nFor more information, refer to the official\nAmazon ECR Lifecycle Policy documentation\n.\n\nBut in this case if my all latest 20 images are older than 180 they will get deleted right"
}