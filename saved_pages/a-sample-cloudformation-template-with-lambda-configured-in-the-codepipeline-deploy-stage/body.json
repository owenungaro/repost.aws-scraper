{
  "body": "On May 16, 2025, Lambda was added to CodePipeline's deploy stage.\n\nOn May 16, 2025, Lambda was added to CodePipeline's deploy stage.\nhttps://aws.amazon.com/jp/about-aws/whats-new/2025/05/aws-codepipeline-deploying-lambda-traffic-shifting/\nPreviously, you needed to use CloudFormation or similar tools to update Lambda code through CodePipeline, but with this update, you can now directly update Lambda functions.\nSample CloudFormation template\nWhen you deploy the following CloudFormation template, it will create a CodePipeline with Lambda configured in the deployment stage.\nPlease enable S3 data events in the CloudTrail trail to detect uploads to S3.\nhttps://docs.aws.amazon.com/AmazonS3/latest/userguide/enable-cloudtrail-logging-for-s3.html\nAWSTemplateFormatVersion\n:\n\"2010-09-09\"\nDescription\n:\nCodePipeline\n,\nLambda\nResources\n:\n# ------------------------------------------------------------#\n# S3\n# ------------------------------------------------------------#\nArtifactBucket\n:\nType\n:\nAWS\n:\n:\nS3\n:\n:\nBucket\nProperties\n:\nBucketEncryption\n:\nServerSideEncryptionConfiguration\n:\n-\nServerSideEncryptionByDefault\n:\nSSEAlgorithm\n:\nAES256\nBucketName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\n-\nartifact\nOwnershipControls\n:\nRules\n:\n-\nObjectOwnership\n:\nBucketOwnerEnforced\nPublicAccessBlockConfiguration\n:\nBlockPublicAcls\n:\nTrue\nBlockPublicPolicy\n:\nTrue\nIgnorePublicAcls\n:\nTrue\nRestrictPublicBuckets\n:\nTrue\nTags\n:\n-\nKey\n:\nName\nValue\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\n-\nartifact\nLambdaBucket\n:\nType\n:\nAWS\n:\n:\nS3\n:\n:\nBucket\nProperties\n:\nBucketName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\nlambda\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nPublicAccessBlockConfiguration\n:\nBlockPublicAcls\n:\ntrue\nBlockPublicPolicy\n:\ntrue\nIgnorePublicAcls\n:\ntrue\nRestrictPublicBuckets\n:\ntrue\nBucketEncryption\n:\nServerSideEncryptionConfiguration\n:\n-\nServerSideEncryptionByDefault\n:\nSSEAlgorithm\n:\nAES256\nOwnershipControls\n:\nRules\n:\n-\nObjectOwnership\n:\nBucketOwnerEnforced\nVersioningConfiguration\n:\nStatus\n:\nEnabled\n# ------------------------------------------------------------#\n# IAM\n# ------------------------------------------------------------#\nLambdaExecutionRole\n:\nType\n:\nAWS\n:\n:\nIAM\n:\n:\nRole\nProperties\n:\nRoleName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\nlambda\n-\nrole\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nAssumeRolePolicyDocument\n:\nVersion\n:\n'2012-10-17'\nStatement\n:\n-\nEffect\n:\nAllow\nPrincipal\n:\nService\n:\nlambda.amazonaws.com\nAction\n:\n'sts:AssumeRole'\nManagedPolicyArns\n:\n-\n'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'\nEventBridgeIAMPolicy\n:\nType\n:\nAWS\n:\n:\nIAM\n:\n:\nManagedPolicy\nProperties\n:\nPolicyDocument\n:\nVersion\n:\n\"2012-10-17\"\nStatement\n:\n-\nEffect\n:\nAllow\nAction\n:\n-\n\"codepipeline:StartPipelineExecution\"\nResource\n:\n-\n!Sub\narn\n:\naws\n:\ncodepipeline\n:\n$\n{\nAWS\n:\n:\nRegion\n}\n:\n$\n{\nAWS\n:\n:\nAccountId\n}\n:\n$\n{\nCodePipeline\n}\nManagedPolicyName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\neventbridge\n-\npolicy\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nEventBridgeIAMRole\n:\nType\n:\nAWS\n:\n:\nIAM\n:\n:\nRole\nProperties\n:\nAssumeRolePolicyDocument\n:\nVersion\n:\n\"2012-10-17\"\nStatement\n:\n-\nEffect\n:\nAllow\nPrincipal\n:\nService\n:\n-\nevents.amazonaws.com\nAction\n:\n-\n'sts:AssumeRole'\nManagedPolicyArns\n:\n-\n!Ref\nEventBridgeIAMPolicy\nRoleName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\neventbridge\n-\nrole\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nTags\n:\n-\nKey\n:\nName\nValue\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\neventbridge\n-\nrole\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nCodePipelineIAMPolicy\n:\nType\n:\nAWS\n:\n:\nIAM\n:\n:\nManagedPolicy\nProperties\n:\nPolicyDocument\n:\nVersion\n:\n\"2012-10-17\"\nStatement\n:\n-\nEffect\n:\nAllow\nAction\n:\n-\n\"s3:GetBucketVersioning\"\n-\n\"s3:GetBucketAcl\"\n-\n\"s3:GetBucketLocation\"\nResource\n:\n-\n!GetAtt\nArtifactBucket.Arn\nCondition\n:\nStringEquals\n:\naws:ResourceAccount\n:\n!Sub\n$\n{\nAWS\n:\n:\nAccountId\n}\n-\nEffect\n:\nAllow\nAction\n:\n-\n\"s3:PutObject\"\n-\n\"s3:PutObjectAcl\"\n-\n\"s3:GetObject\"\n-\n\"s3:GetObjectVersion\"\nResource\n:\n-\n!Sub\n$\n{\nArtifactBucket.Arn\n}\n/*\nCondition\n:\nStringEquals\n:\naws:ResourceAccount\n:\n!Sub\n$\n{\nAWS\n:\n:\nAccountId\n}\n-\nEffect\n:\nAllow\nAction\n:\n-\n\"lambda:GetAlias\"\n-\n\"lambda:GetFunctionConfiguration\"\n-\n\"lambda:GetProvisionedConcurrencyConfig\"\n-\n\"lambda:PublishVersion\"\n-\n\"lambda:UpdateAlias\"\n-\n\"lambda:UpdateFunctionCode\"\nResource\n:\n-\n!Sub\n$\n{\nLambda.Arn\n}\n-\n!Sub\n$\n{\nLambda.Arn\n}\n:\n*\n-\nEffect\n:\nAllow\nAction\n:\n-\n\"logs:CreateLogGroup\"\nResource\n:\n-\n!Sub\narn\n:\naws\n:\nlogs\n:\n$\n{\nAWS\n:\n:\nRegion\n}\n:\n$\n{\nAWS\n:\n:\nAccountId\n}\n:\nlog\n-\ngroup\n:\n/aws/codepipeline/$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\n-\n!Sub\narn\n:\naws\n:\nlogs\n:\n$\n{\nAWS\n:\n:\nRegion\n}\n:\n$\n{\nAWS\n:\n:\nAccountId\n}\n:\nlog\n-\ngroup\n:\n/aws/codepipeline/$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\n:\n*\n-\nEffect\n:\nAllow\nAction\n:\n-\n\"logs:CreateLogStream\"\n-\n\"logs:PutLogEvents\"\nResource\n:\n-\n!Sub\narn\n:\naws\n:\nlogs\n:\n$\n{\nAWS\n:\n:\nRegion\n}\n:\n$\n{\nAWS\n:\n:\nAccountId\n}\n:\nlog\n-\ngroup\n:\n/aws/codepipeline/$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\n:\nlog\n-\nstream\n:\n*\n-\nEffect\n:\nAllow\nAction\n:\n-\n\"s3:GetObject\"\n-\n\"s3:GetObjectVersion\"\n-\n\"s3:GetBucketVersioning\"\n-\n\"s3:GetBucketAcl\"\n-\n\"s3:GetBucketLocation\"\n-\n\"s3:GetObjectTagging\"\n-\n\"s3:GetObjectVersionTagging\"\nResource\n:\n-\n!Sub\n$\n{\nLambdaBucket.Arn\n}\n-\n!Sub\n$\n{\nLambdaBucket.Arn\n}\n/*\nCondition\n:\nStringEquals\n:\naws:ResourceAccount\n:\n!Sub\n$\n{\nAWS\n:\n:\nAccountId\n}\nManagedPolicyName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\n-\npolicy\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nCodePipelineIAMRole\n:\nType\n:\nAWS\n:\n:\nIAM\n:\n:\nRole\nProperties\n:\nAssumeRolePolicyDocument\n:\nVersion\n:\n\"2012-10-17\"\nStatement\n:\n-\nEffect\n:\nAllow\nPrincipal\n:\nService\n:\n-\ncodepipeline.amazonaws.com\nAction\n:\n-\n'sts:AssumeRole'\nManagedPolicyArns\n:\n-\n!Ref\nCodePipelineIAMPolicy\nRoleName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\n-\nrole\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nTags\n:\n-\nKey\n:\nName\nValue\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\n-\nrole\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\n# ------------------------------------------------------------#\n# Lambda\n# ------------------------------------------------------------#\nLambda\n:\nType\n:\nAWS\n:\n:\nLambda\n:\n:\nFunction\nProperties\n:\nFunctionName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\nlambda\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nRuntime\n:\npython3.13\nHandler\n:\nindex.lambda_handler\nRole\n:\n!GetAtt\nLambdaExecutionRole.Arn\nCode\n:\nZipFile\n:\n|\nimport json\ndef lambda_handler(event\n,\ncontext)\n:\n# TODO implement\nreturn\n{\n'statusCode'\n:\n200\n,\n'body'\n:\njson.dumps('Hello from Lambda\n!')\n}\nTimeout\n:\n10\n# ------------------------------------------------------------#\n# Codepipeline\n# ------------------------------------------------------------#\nCodePipeline\n:\nType\n:\nAWS\n:\n:\nCodePipeline\n:\n:\nPipeline\nProperties\n:\nArtifactStore\n:\nLocation\n:\n!Ref\nArtifactBucket\nType\n:\nS3\nName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\nRoleArn\n:\n!GetAtt\nCodePipelineIAMRole.Arn\nStages\n:\n-\nActions\n:\n-\nActionTypeId\n:\nCategory\n:\nSource\nOwner\n:\nAWS\nProvider\n:\nS3\nVersion\n:\n1\nConfiguration\n:\nS3Bucket\n:\n!Ref\nLambdaBucket\nS3ObjectKey\n:\nlambda.zip\nName\n:\nSource\nNamespace\n:\nSourceVariables\nOutputArtifacts\n:\n-\nName\n:\nSourceArtifact\nRegion\n:\nap\n-\nnortheast\n-\n1\nRunOrder\n:\n1\nName\n:\nSource\n-\nActions\n:\n-\nActionTypeId\n:\nCategory\n:\nDeploy\nOwner\n:\nAWS\nProvider\n:\nLambda\nVersion\n:\n1\nConfiguration\n:\nFunctionName\n:\n!Ref\nLambda\nName\n:\nDeploy\nNamespace\n:\nDeployVariables\nInputArtifacts\n:\n-\nName\n:\nSourceArtifact\nRegion\n:\nap\n-\nnortheast\n-\n1\nRunOrder\n:\n1\nName\n:\nDeploy\nTags\n:\n-\nKey\n:\nName\nValue\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\ncodepipeline\n# ------------------------------------------------------------#\n# EventBridge\n# ------------------------------------------------------------#\nEventBridge\n:\nType\n:\nAWS\n:\n:\nEvents\n:\n:\nRule\nProperties\n:\nDescription\n:\nfor codepipeline\nEventPattern\n:\nsource\n:\n-\naws.s3\ndetail-type\n:\n-\n'AWS API Call via CloudTrail'\ndetail\n:\neventSource\n:\n-\ns3.amazonaws.com\nevent\n:\n-\nPutObject\n-\nCompleteMultipartUpload\n-\nCopyObject\nrequestParameters\n:\nbucketName\n:\n-\n!Ref\nLambdaBucket\nkey\n:\n-\nlambda.zip\nName\n:\n!Sub\n$\n{\nAWS\n:\n:\nStackName\n}\n-\neventbridge\n-\n$\n{\nAWS\n:\n:\nAccountId\n}\nState\n:\nENABLED\nTargets\n:\n-\nArn\n:\n!Sub\narn\n:\naws\n:\ncodepipeline\n:\n$\n{\nAWS\n:\n:\nRegion\n}\n:\n$\n{\nAWS\n:\n:\nAccountId\n}\n:\n$\n{\nCodePipeline\n}\nId\n:\nCodePipeline\nRoleArn\n:\n!GetAtt\nEventBridgeIAMRole.Arn\nTest\nOnce the CloudFormation template is deployed, please upload your zip-compressed Lambda function to the S3 bucket named \"CloudFormationStackName-lambda-YourAccountID\".\nPlease name the zip file \"lambda.zip\".\nAlso, please name the Lambda function file \"index.py\".\nOnce you upload the file, you can confirm that CodePipeline is executed and the Lambda code is updated as shown below."
}