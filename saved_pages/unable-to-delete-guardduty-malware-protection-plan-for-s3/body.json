{
  "body": "Hi\nI am currently in learning phase of usage of Guardduty . I created an S3 bucket and enabled guardduty scan and then enabled the guardduty malware protection plan for s3 , now when I try to delete/disable the plan , it gives me an error on the console as well as on Cloudshell. I also tried to delete the plan using aws cli.\nError - The request was rejected because the provided IAM role cannot be assumed by the service.\nI tried to edit the plan to change the Role , but no luck.\nSo the I tried to delete the s3 bucket, which I was able to do successfully. However I still cannot delete Guardduty Malware protection plan\nIs there something that I can do to remove the plan ?\n\nTo resolve your issue with deleting the GuardDuty Malware Protection plan for S3, you'll need to use the AWS CLI with the correct Malware Protection plan ID. Since the bucket has already been deleted, you're experiencing an error because the service can't validate against a non-existent bucket or the IAM role may have been modified.\nHere's how to delete the Malware Protection plan:\nFirst, retrieve the Malware Protection plan ID by running:\naws guardduty list-malware-protection-plans --region your-region\nReplace \"your-region\" with your specific AWS region.\nOnce you have the plan ID, delete it using:\naws guardduty delete-malware-protection-plan --malware-protection-plan-id your-plan-id\nReplace \"your-plan-id\" with the ID you obtained in the previous step.\nIf you're still encountering issues, it might be related to IAM role permissions or eventual consistency after deleting the bucket. In some cases, you may need to wait a few minutes for the changes to propagate through AWS systems before attempting to delete the protection plan again.\nFor Infrastructure as Code deployments, it's recommended to declare resource dependencies to ensure proper sequencing when creating or deleting resources. This helps avoid issues with eventual consistency when managing GuardDuty Malware Protection plans.\nSources\nDisabling Malware Protection for S3 for a protected bucket - Amazon GuardDuty\nTroubleshooting IAM role permissions error - Amazon GuardDuty\n\nLooking at your issue, I think I know what is happening. Since you've already deleted the S3 bucket, the error you're seeing is likely because GuardDuty can't validate against the deleted bucket, or there might be some IAM role conflicts.\nLet me share an easier way to delete the plan using AWS CLI:\nFirst, get your Malware Protection plan ID:\naws guardduty list-malware-protection-plans --region your-region\nThen use that ID to delete the plan:\naws guardduty delete-malware-protection-plan --malware-protection-plan-id your-plan-id\nIf it still doesn't work right away, give it a few minutes and try again. AWS sometimes needs some time for these changes to sync up across their systems (they call it eventual consistency).\nOh, and a small tip for the future - if you're using Infrastructure as Code, it's better to set up proper resource dependencies. That way, when you're creating or deleting resources, everything happens in the right order and you avoid these kinds of stuck states.\nHope this helps solve your problem! Let me know if you run into any other issues."
}